---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: x2a-sa
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: x2a-role
rules:
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["create", "get", "list", "watch", "delete"]
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create", "get", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: x2a-rolebinding
subjects:
  - kind: ServiceAccount
    name: x2a-sa
roleRef:
  kind: Role
  name: x2a-role
  apiGroup: rbac.authorization.k8s.io
---
# ClusterRole/ClusterRoleBinding for x2a-sa to pass the plugin's connection test
# which hardcodes a pod list call against the 'default' namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: x2a-cluster-role
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: x2a-cluster-rolebinding
subjects:
  - kind: ServiceAccount
    name: x2a-sa
    namespace: x2ansible
roleRef:
  kind: ClusterRole
  name: x2a-cluster-role
  apiGroup: rbac.authorization.k8s.io
---
# X2A Backstage Plugin Application Resources
# Apply to any namespace using: oc apply -n <your-namespace> -f app.yaml
#
# ConfigMap: Dynamic Plugins Configuration
kind: ConfigMap
apiVersion: v1
metadata:
  name: dynamic-plugins
  # namespace field intentionally omitted - use -n flag when applying
data:
  dynamic-plugins.yaml: |
    includes:
      - dynamic-plugins.default.yaml
    plugins:
      # CUSTOMIZATION: Update plugin versions by changing the tag after the colon
      - package: "oci://ghcr.io/redhat-developer/rhdh-plugin-export-overlays/red-hat-developer-hub-backstage-plugin-x2a:bs_1.45.3__1.0.1!red-hat-developer-hub-backstage-plugin-x2a"
        disabled: false
      - package: "oci://ghcr.io/redhat-developer/rhdh-plugin-export-overlays/red-hat-developer-hub-backstage-plugin-x2a-backend:bs_1.45.3__1.0.1!red-hat-developer-hub-backstage-plugin-x2a-backend"
        disabled: false
---
# ConfigMap: Application Configuration
kind: ConfigMap
apiVersion: v1
metadata:
  name: app-config-rhdh
data:
  app-config-rhdh.yaml: |

    auth:
      # see https://backstage.io/docs/auth/ to learn about auth providers
      environment: development
      providers:
        # See https://backstage.io/docs/auth/guest/provider
        guest: {}

        github:
          development:
            clientId: ${AUTH_GITHUB_CLIENT_ID}
            clientSecret: ${AUTH_GITHUB_CLIENT_SECRET}
            signIn:
              resolvers:
                - resolver: usernameMatchingUserEntityName
                  dangerouslyAllowSignInWithoutUserInCatalog: true

    dynamicPlugins:
      frontend:
        red-hat-developer-hub.backstage-plugin-x2a:
          dynamicRoutes:
            - path: /x2a
              importName: X2APage
              menuItem:
                text: X2A
                # icon: CloudQueue

    x2a:
      kubernetes:
        namespace: ${X2A_KUBERNETES_NAMESPACE:-default}
        image: ${X2A_KUBERNETES_IMAGE:-quay.io/x2ansible/x2a-convertor}
        imageTag: ${X2A_KUBERNETES_IMAGE_TAG:-latest}
        ttlSecondsAfterFinished: 86400
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 4Gi
      credentials:
        llm:
          LLM_MODEL: ${LLM_MODEL:-anthropic.claude-v2}
          # Example for AWS Bedrock with bearer token:
          AWS_REGION: ${AWS_REGION}
          AWS_BEARER_TOKEN_BEDROCK: ${AWS_BEARER_TOKEN_BEDROCK}
        aap:
          url: ${AAP_URL:-https://aap.example.com}
          orgName: ${AAP_ORG_NAME:-MyOrganization}
          oauthToken: ${AAP_OAUTH_TOKEN:-your-oauth-token}
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: dynamic-plugins-root
spec:
  accessModes:
    - ReadWriteOnce
  # CUSTOMIZATION: Change storage class for your environment
  # Common values:
  #   - OpenShift CRC: crc-csi-hostpath-provisioner
  #   - AWS EBS: gp2 or gp3
  #   - Azure: managed-premium
  #   - GCP: standard or standard-rwo
  # List available storage classes: oc get storageclass
  storageClassName: crc-csi-hostpath-provisioner
  resources:
    requests:
      storage: 2Gi
---
apiVersion: rhdh.redhat.com/v1alpha4
kind: Backstage
metadata:
  name: developer-hub
spec:
  deployment:
    patch:
      spec:
        template:
          spec:
            serviceAccountName: x2a-sa
            automountServiceAccountToken: true
  application:
    dynamicPluginsConfigMapName: dynamic-plugins
    appConfig:
      mountPath: /opt/app-root/src
      configMaps:
        - name: app-config-rhdh
    extraFiles:
      mountPath: /opt/app-root/src
    extraEnvs:
      envs:
        # - name: LOG_LEVEL
        #   value: INFO
        # - name: NO_PROXY
        #   value: localhost,127.0.0.1,.cluster.local,.svc,172.31.0.0/16
        - name: NODE_TLS_REJECT_UNAUTHORIZED
          value: "0"
      secrets:
        - name: x2a-credentials
    route:
      enabled: true
